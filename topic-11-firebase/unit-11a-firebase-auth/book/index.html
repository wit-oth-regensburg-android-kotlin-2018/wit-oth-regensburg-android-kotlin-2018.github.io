<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css"
          type="text/css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"
          rel="stylesheet"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
      

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



      

html, body {
  height: 100%;
  margin: 0;
}
.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.footer {
  background: white;
  text-align: right;
}
.content {
  flex: 1;
  overflow: auto;
}



    </style>
  </head>

  
  

  <div class="ui fixed top pointing inverted stackable menu labmenu">
    <header class="header item">
      <i id="toc" class="sitemap icon"></i>
      
        <a href="../../index.html"> Firebase Authentication  </a>
      
    </header>
    <div class="right tab-menu menu">
      
        <a class="item" data-tab="Lab-11a Firebase Auth">
          Lab-11a Firebase Auth
        </a>
      
        <a class="item" data-tab="01">
          01
        </a>
      
        <a class="item" data-tab="02">
          02
        </a>
      
        <a class="item" data-tab="03">
          03
        </a>
      
        <a class="item" data-tab="04">
          04
        </a>
      
        <a class="item" data-tab="05">
          05
        </a>
      
        <a class="item" data-tab="06">
          06
        </a>
      
        <a class="item" data-tab="07">
          07
        </a>
      
        <a class="item" data-tab="08">
          08
        </a>
      
        <a class="item" data-tab="Exercises">
          Exercises
        </a>
      
    </div>
  </div>


  

  <div class="ui pushable">
    <div class="ui inverted labeled icon left inline vertical sidebar menu">
      <br><br>
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-00-overview/unit-2-android/book-00-studio/index.html">Lab-00 Studio </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-01-activity/unit-01b-android-activitiy/book-01-activity/index.html">Lab-01 Activities </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-02-adapters/unit-02b-android-adapters/book-02-adapters/index.html">Lab-02 Adapters </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-03-models/unit-03b-android-models/book-03-models/index.html">Lab-03 Models </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-04-images/unit-04b-images/book-04-images/index.html">Lab-04 Images </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-05-map-activity/unit-05b-map-activity/book-maps/index.html">Lab-05 MapActivity </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-06-persistence/unit-06b-json/book-json/index.html">Lab-06 JSON </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-07-layouts/unit-07b-map-view/book-0-map-view/index.html">Lab-07 MapView </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-08-mvp/unit-08b/book-1-mvp-1/index.html">Lab-08a MVP I </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-08-mvp/unit-08c/book-2-mvp-2/index.html">Lab-08b MVP II </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-09-location/unit-09b-location/book-1-location/index.html">Lab-09a Location </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-09-location/unit-09c/book-2-location/index.html">Lab-09b Tracking </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-10-rooms/unit-10b-version-mgmt/book-1/index.html">Lab-10a AndroidX </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-10-rooms/unit-10c-rooms/book-1/index.html">Lab-10b Rooms </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-11-firebase/unit-11a-firebase-auth/book/index.html">Lab-11a Firebase Auth </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-11-firebase/unit-11b/book/index.html">Lab-11b Firebase Database </a>
          
        
      
        
          
            <a class="item"
               href="https://wit-oth-regensburg-android-kotlin-2018.github.io//topic-11-firebase/unit-11c/book/index.html">Lab-11c Firebase Storage </a>
          
        
      
    </div>
    <div class="pusher" tabindex="-1">
      <div class="ui basic segment">
        <br>
        
          <div class="ui tab segment lab" data-tab="Lab-11a Firebase Auth">
            <h1>Objectives</h1>
<p>Authenticate users against the Firebase Authentication service</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="01">
            <h1>Exercise</h1>
<p>Rework the PlacemarkModel so that, instead repeating lat/lng/zoom in each placemark, we embed a Location object. In order to implement this in the context of the Room system, you will need to use the <code>@Embedded</code> annotation:</p>
<ul>
<li><a href="https://developer.android.com/reference/android/arch/persistence/room/Embedded">https://developer.android.com/reference/android/arch/persistence/room/Embedded</a></li>
</ul>
<p>Also, you will also have to adjust the other Store implementations.</p>
<h2>Solution</h2>
<p>Revised PlacemarkModel:</p>
<h2>PlacemarkModel</h2>
<pre><code>package org.wit.placemark.models

import android.os.Parcelable
import androidx.room.Embedded
import androidx.room.Entity
import androidx.room.PrimaryKey
import kotlinx.android.parcel.Parcelize

@Parcelize
@Entity
data class PlacemarkModel(@PrimaryKey(autoGenerate = true) var id: Long = 0,
                          var title: String = &quot;&quot;,
                          var description: String = &quot;&quot;,
                          var image: String = &quot;&quot;,
                          @Embedded var location : Location = Location()): Parcelable

@Parcelize
data class Location(var lat: Double = 0.0,
                    var lng: Double = 0.0,
                    var zoom: Float = 0f) : Parcelable</code></pre>
<p>Revised update methods in some existing PlacemarmStore implementations:</p>
<h2>PlacemarkMemStore</h2>
<pre><code>  suspend override fun update(placemark: PlacemarkModel) {
    var foundPlacemark: PlacemarkModel? = placemarks.find { p -&gt; p.id == placemark.id }
    if (foundPlacemark != null) {
      foundPlacemark.title = placemark.title
      foundPlacemark.description = placemark.description
      foundPlacemark.image = placemark.image
      foundPlacemark.location = placemark.location
      logAll();
    }
  }</code></pre>
<h2>PlacemarkJSONStore</h2>
<pre><code>  suspend override fun update(placemark: PlacemarkModel) {
    val placemarksList = findAll() as ArrayList&lt;PlacemarkModel&gt;
    var foundPlacemark: PlacemarkModel? = placemarksList.find { p -&gt; p.id == placemark.id }
    if (foundPlacemark != null) {
      foundPlacemark.title = placemark.title
      foundPlacemark.description = placemark.description
      foundPlacemark.image = placemark.image
      foundPlacemark.location = placemark.location
    }
    serialize()
  }</code></pre>
<p>One View will need revision:</p>
<h2>PlacemarkView</h2>
<pre><code>...
    lat.setText(&quot;%.6f&quot;.format(placemark.location.lat))
    lng.setText(&quot;%.6f&quot;.format(placemark.location.lng))
...</code></pre>
<p>We can rework the PlacemarkPresenter to be marginally simplified:</p>
<h2>PlacemarkPresenter</h2>
<pre><code>package org.wit.placemark.views.placemark

import android.annotation.SuppressLint
import android.content.Intent
import com.google.android.gms.location.FusedLocationProviderClient
import com.google.android.gms.location.LocationCallback
import com.google.android.gms.location.LocationResult
import com.google.android.gms.location.LocationServices
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.GoogleMap
import com.google.android.gms.maps.model.LatLng
import com.google.android.gms.maps.model.MarkerOptions
import kotlinx.coroutines.experimental.android.UI
import kotlinx.coroutines.experimental.async
import org.wit.placemark.helpers.checkLocationPermissions
import org.wit.placemark.helpers.createDefaultLocationRequest
import org.wit.placemark.helpers.isPermissionGranted
import org.wit.placemark.helpers.showImagePicker
import org.wit.placemark.models.Location
import org.wit.placemark.models.PlacemarkModel
import org.wit.placemark.views.*

class PlacemarkPresenter(view: BaseView) : BasePresenter(view) {

  var map: GoogleMap? = null
  var placemark = PlacemarkModel()
  var defaultLocation = Location(52.245696, -7.139102, 15f)
  var edit = false;
  var locationService: FusedLocationProviderClient = LocationServices.getFusedLocationProviderClient(view)
  val locationRequest = createDefaultLocationRequest()

  init {
    if (view.intent.hasExtra(&quot;placemark_edit&quot;)) {
      edit = true
      placemark = view.intent.extras.getParcelable&lt;PlacemarkModel&gt;(&quot;placemark_edit&quot;)
      view.showPlacemark(placemark)
    } else {
      if (checkLocationPermissions(view)) {
        doSetCurrentLocation()
      }
    }
  }

  @SuppressLint(&quot;MissingPermission&quot;)
  fun doSetCurrentLocation() {
    locationService.lastLocation.addOnSuccessListener {
      locationUpdate(Location(it.latitude, it.longitude))
    }
  }

  @SuppressLint(&quot;MissingPermission&quot;)
  fun doResartLocationUpdates() {

    var locationCallback = object : LocationCallback() {
      override fun onLocationResult(locationResult: LocationResult?) {
        if (locationResult != null &amp;&amp; locationResult.locations != null) {
          val l = locationResult.locations.last()
          locationUpdate(Location(l.latitude, l.longitude))
        }
      }
    }
    if (!edit) {
      locationService.requestLocationUpdates(locationRequest, locationCallback, null)
    }
  }

  override fun doRequestPermissionsResult(requestCode: Int, permissions: Array&lt;String&gt;, grantResults: IntArray) {
    if (isPermissionGranted(requestCode, grantResults)) {
      doSetCurrentLocation()
    } else {
      locationUpdate(defaultLocation)
    }
  }

  fun doConfigureMap(m: GoogleMap) {
    map = m
    locationUpdate(placemark.location)
  }

  fun locationUpdate(location: Location) {
    placemark.location = location
    placemark.location.zoom = 15f
    map?.clear()
    map?.uiSettings?.setZoomControlsEnabled(true)
    val options = MarkerOptions().title(placemark.title).position(LatLng(placemark.location.lat, placemark.location.lng))
    map?.addMarker(options)
    map?.moveCamera(CameraUpdateFactory.newLatLngZoom(LatLng(placemark.location.lat, placemark.location.lng), placemark.location.zoom))
    view?.showPlacemark(placemark)
  }


  fun doAddOrSave(title: String, description: String) {
    placemark.title = title
    placemark.description = description
    async(UI) {
      if (edit) {
        app.placemarks.update(placemark)
      } else {
        app.placemarks.create(placemark)
      }
      view?.finish()
    }
  }

  fun doCancel() {
    view?.finish()
  }

  fun doDelete() {
    async(UI) {
      app.placemarks.delete(placemark)
      view?.finish()
    }
  }

  fun doSelectImage() {
    view?.let {
      showImagePicker(view!!, IMAGE_REQUEST)
    }
  }

  fun doSetLocation() {
    view?.navigateTo(VIEW.LOCATION, LOCATION_REQUEST, &quot;location&quot;, Location(placemark.location.lat, placemark.location.lng, placemark.location.zoom))
  }

  override fun doActivityResult(requestCode: Int, resultCode: Int, data: Intent) {
    when (requestCode) {
      IMAGE_REQUEST -&gt; {
        placemark.image = data.data.toString()
        view?.showPlacemark(placemark)
      }
      LOCATION_REQUEST -&gt; {
        val location = data.extras.getParcelable&lt;Location&gt;(&quot;location&quot;)
        placemark.location = location
        locationUpdate(location)
      }
    }
  }
}</code></pre>
<p>Finally, PlacemarkMapPresenter:</p>
<h2>PlacemarkMapPresenter</h2>
<pre><code>  fun doPopulateMap(map: GoogleMap, placemarks: List&lt;PlacemarkModel&gt;) {
    map.uiSettings.setZoomControlsEnabled(true)
    placemarks.forEach {
      val loc = LatLng(it.location.lat, it.location.lng)
      val options = MarkerOptions().title(it.title).position(loc)
      map.addMarker(options).tag = it.id
      map.moveCamera(CameraUpdateFactory.newLatLngZoom(loc, it.location.zoom))
    }
  }</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="02">
            <h1>Login Layout</h1>
<p>We would like to introduce a new Login screen - which will be presented before any user logs in:</p>
<p><img src="img/01x.png" alt=""></p>
<p>We need these new string resources:</p>
<h2>strings.xml</h2>
<pre><code>  &lt;string name=&quot;title_activity_login&quot;&gt; Signup/Login to Placemark&lt;/string&gt;</code></pre>
<p>This is the login layout:</p>
<h2>res/layout/activity_login.xml</h2>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;androidx.constraintlayout.widget.ConstraintLayout
  xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
  xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
  xmlns:tools=&quot;http://schemas.android.com/tools&quot;
  android:layout_width=&quot;match_parent&quot;
  android:layout_height=&quot;match_parent&quot;
  tools:context=&quot;org.wit.placemark.views.login.LoginView&quot;&gt;

  &lt;com.google.android.material.appbar.AppBarLayout
    android:id=&quot;@+id/appBarLayout&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;wrap_content&quot;
    android:background=&quot;@color/colorAccent&quot;
    android:fitsSystemWindows=&quot;true&quot;
    app:elevation=&quot;0dip&quot;
    app:theme=&quot;@style/ThemeOverlay.AppCompat.Dark.ActionBar&quot;&gt;

    &lt;androidx.appcompat.widget.Toolbar
      android:id=&quot;@+id/toolbar&quot;
      android:layout_width=&quot;match_parent&quot;
      android:layout_height=&quot;wrap_content&quot;
      app:titleTextColor=&quot;@color/colorPrimary&quot; /&gt;

  &lt;/com.google.android.material.appbar.AppBarLayout&gt;

  &lt;androidx.constraintlayout.widget.ConstraintLayout
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:layout_marginStart=&quot;8dp&quot;
    android:layout_marginEnd=&quot;8dp&quot;
    android:layout_marginBottom=&quot;16dp&quot;
    app:layout_constraintBottom_toBottomOf=&quot;parent&quot;
    app:layout_constraintEnd_toEndOf=&quot;parent&quot;
    app:layout_constraintHorizontal_bias=&quot;0.0&quot;
    app:layout_constraintStart_toStartOf=&quot;parent&quot;
    app:layout_constraintTop_toTopOf=&quot;parent&quot;
    app:layout_constraintVertical_bias=&quot;0.0&quot;&gt;


    &lt;EditText
      android:id=&quot;@+id/email&quot;
      android:layout_width=&quot;237dp&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:layout_marginStart=&quot;8dp&quot;
      android:layout_marginTop=&quot;108dp&quot;
      android:layout_marginEnd=&quot;36dp&quot;
      android:ems=&quot;10&quot;
      android:inputType=&quot;textEmailAddress&quot;
      app:layout_constraintEnd_toEndOf=&quot;parent&quot;
      app:layout_constraintHorizontal_bias=&quot;1.0&quot;
      app:layout_constraintStart_toEndOf=&quot;@+id/textView&quot;
      app:layout_constraintTop_toTopOf=&quot;parent&quot; /&gt;

    &lt;TextView
      android:id=&quot;@+id/textView&quot;
      android:layout_width=&quot;72dp&quot;
      android:layout_height=&quot;23dp&quot;
      android:layout_marginStart=&quot;16dp&quot;
      android:text=&quot;Email&quot;
      android:textAlignment=&quot;textEnd&quot;
      app:layout_constraintBaseline_toBaselineOf=&quot;@+id/email&quot;
      app:layout_constraintStart_toStartOf=&quot;parent&quot; /&gt;

    &lt;EditText
      android:id=&quot;@+id/password&quot;
      android:layout_width=&quot;239dp&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:layout_marginTop=&quot;8dp&quot;
      android:ems=&quot;10&quot;
      android:inputType=&quot;textPassword&quot;
      app:layout_constraintBottom_toBottomOf=&quot;parent&quot;
      app:layout_constraintEnd_toEndOf=&quot;@+id/email&quot;
      app:layout_constraintHorizontal_bias=&quot;0.0&quot;
      app:layout_constraintStart_toStartOf=&quot;@+id/email&quot;
      app:layout_constraintTop_toBottomOf=&quot;@+id/email&quot;
      app:layout_constraintVertical_bias=&quot;0.026&quot; /&gt;

    &lt;TextView
      android:id=&quot;@+id/textView2&quot;
      android:layout_width=&quot;70dp&quot;
      android:layout_height=&quot;29dp&quot;
      android:text=&quot;Password&quot;
      android:textAlignment=&quot;textEnd&quot;
      app:layout_constraintBaseline_toBaselineOf=&quot;@+id/password&quot;
      app:layout_constraintEnd_toEndOf=&quot;@+id/textView&quot;
      app:layout_constraintHorizontal_bias=&quot;1.0&quot;
      app:layout_constraintStart_toStartOf=&quot;@+id/textView&quot; /&gt;

    &lt;Button
      android:id=&quot;@+id/signUp&quot;
      android:layout_width=&quot;169dp&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:layout_marginStart=&quot;8dp&quot;
      android:layout_marginTop=&quot;32dp&quot;
      android:text=&quot;Sign Up&quot;
      app:layout_constraintStart_toStartOf=&quot;parent&quot;
      app:layout_constraintTop_toBottomOf=&quot;@+id/textView2&quot; /&gt;

    &lt;Button
      android:id=&quot;@+id/logIn&quot;
      android:layout_width=&quot;169dp&quot;
      android:layout_height=&quot;wrap_content&quot;
      android:layout_marginStart=&quot;8dp&quot;
      android:layout_marginTop=&quot;8dp&quot;
      android:layout_marginEnd=&quot;8dp&quot;
      android:text=&quot;Log In&quot;
      app:layout_constraintBottom_toBottomOf=&quot;@+id/signUp&quot;
      app:layout_constraintEnd_toEndOf=&quot;parent&quot;
      app:layout_constraintHorizontal_bias=&quot;1.0&quot;
      app:layout_constraintStart_toEndOf=&quot;@+id/signUp&quot;
      app:layout_constraintTop_toBottomOf=&quot;@+id/password&quot;
      app:layout_constraintVertical_bias=&quot;1.0&quot; /&gt;
  &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;

&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="03">
            <h1>Login View/Presenter</h1>
<p>Our first version will just let the user signup/login without paying any attention to what they enter as credentials.</p>
<h2>LoginPresenter</h2>
<pre><code>package org.wit.placemark.views.login

import org.wit.placemark.views.BasePresenter
import org.wit.placemark.views.BaseView
import org.wit.placemark.views.VIEW

class LoginPresenter(view: BaseView) : BasePresenter(view) {

  fun doLogin(email: String, password: String) {
    view?.navigateTo(VIEW.LIST)
  }

  fun doSignUp(email: String, password: String) {
    view?.navigateTo(VIEW.LIST)
  }
}</code></pre>
<h2>LoginView</h2>
<pre><code>package org.wit.placemark.views.login

import android.os.Bundle
import kotlinx.android.synthetic.main.activity_login.*
import org.jetbrains.anko.toast
import org.wit.placemark.R
import org.wit.placemark.views.BaseView

class LoginView : BaseView() {

  lateinit var presenter: LoginPresenter

  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    setContentView(R.layout.activity_login)
    init(toolbar, false)

    presenter = initPresenter(LoginPresenter(this)) as LoginPresenter

    signUp.setOnClickListener {
      val email = email.text.toString()
      val password = password.text.toString()
      if (email == &quot;&quot; || password == &quot;&quot;) {
        toast(&quot;Please provide email + password&quot;)
      }
      else {
        presenter.doSignUp(email,password)
      }
    }

    logIn.setOnClickListener {
      val email = email.text.toString()
      val password = password.text.toString()
      if (email == &quot;&quot; || password == &quot;&quot;) {
        toast(&quot;Please provide email + password&quot;)
      }
      else {
        presenter.doLogin(email,password)
      }
    }
  }
}</code></pre>
<p>In the above, note that we just start the PlacemarkListView, regardless of which button is pressed - or what is entered.</p>
<p>The manifest needs to be altered to now nominate this LoginView as the <code>launch</code> activity:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
  package=&quot;org.wit.placemark&quot;&gt;

  &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot; /&gt;

  &lt;application
    android:name=&quot;.main.MainApp&quot;
    android:allowBackup=&quot;true&quot;
    android:icon=&quot;@mipmap/ic_launcher&quot;
    android:label=&quot;@string/app_name&quot;
    android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;
    android:supportsRtl=&quot;true&quot;
    android:theme=&quot;@style/AppTheme&quot;&gt;

    &lt;activity android:name=&quot;.views.login.LoginView&quot;
      android:label=&quot;@string/title_activity_login&quot;
      android:launchMode=&quot;singleTop&quot;&gt;
      &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;
        &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;
        &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
      &lt;/intent-filter&gt;
    &lt;/activity&gt;

    &lt;activity android:name=&quot;.views.placemarklist.PlacemarkListView&quot;
      android:label=&quot;@string/title_activity_placemark_list&quot;
      android:launchMode=&quot;singleTop&quot;&gt;
    &lt;/activity&gt;

    &lt;activity android:name=&quot;.views.placemark.PlacemarkView&quot;
      android:label=&quot;@string/title_activity_placemark&quot;&gt;
      &lt;meta-data
        android:name=&quot;android.support.PARENT_ACTIVITY&quot;
        android:value=&quot;.views.placemarklist.PlacemarkListView&quot; /&gt;
    &lt;/activity&gt;

    &lt;activity
      android:name=&quot;.views.editlocation.EditLocationView&quot;
      android:label=&quot;@string/title_activity_edit_location&quot;&gt;
      &lt;meta-data
        android:name=&quot;android.support.PARENT_ACTIVITY&quot;
        android:value=&quot;.views.placemark.PlacemarkView&quot; /&gt;
    &lt;/activity&gt;

    &lt;activity
      android:name=&quot;.views.map.PlacemarkMapView&quot;
      android:label=&quot;@string/title_activity_placemark_maps&quot;
      android:launchMode=&quot;singleTop&quot;&gt;
      &lt;meta-data
        android:name=&quot;android.support.PARENT_ACTIVITY&quot;
        android:value=&quot;.views.placemarklist.PlacemarkListView&quot; /&gt;
    &lt;/activity&gt;

    &lt;meta-data
      android:name=&quot;com.google.android.geo.API_KEY&quot;
      android:value=&quot;@string/google_maps_key&quot; /&gt;

  &lt;/application&gt;

&lt;/manifest&gt;</code></pre>
<p>Run the app now - it should display the login activity first, and take you to the placemark list when you press either button.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="04">
            <h1>Logout</h1>
<p>As we now support log in - we also need to support logout. This will require a change to our existing menus in PlacemarkListView. Once logged in the AppBar will be reconfigured to have a drop down menu:</p>
<p><img src="img/03x.png" alt=""></p>
<p><img src="img/04x.png" alt=""></p>
<p>First, some new/revised strings:</p>
<h2>res/values/strings.xml</h2>
<pre><code>  &lt;string name=&quot;menu_showMap&quot;&gt;Show Map&lt;/string&gt;
  &lt;string name=&quot;menu_logout&quot;&gt;Logout&lt;/string&gt;</code></pre>
<p>This is the revised menu </p>
<h2>memu_main.xml</h2>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;menu xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
  xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;&gt;

  &lt;item
    android:id=&quot;@+id/item_add&quot;
    android:icon=&quot;@android:drawable/ic_menu_add&quot;
    android:title=&quot;@string/menu_addPlacemark&quot;
    app:showAsAction=&quot;never&quot;/&gt;

  &lt;item
    android:id=&quot;@+id/item_map&quot;
    android:icon=&quot;@android:drawable/ic_menu_mapmode&quot;
    android:title=&quot;@string/menu_showMap&quot;
    app:showAsAction=&quot;never&quot;/&gt;

  &lt;item
    android:id=&quot;@+id/item_logout&quot;
    android:title=&quot;@string/menu_logout&quot;
    android:visible=&quot;true&quot;
    app:showAsAction=&quot;never&quot; /&gt;
&lt;/menu&gt;</code></pre>
<p>In order to Launch a view, we have been encapsulating the start procedure in BaseView:</p>
<h2>BaseView</h2>
<pre><code>...
import org.wit.placemark.views.login.LoginView
...
enum class VIEW {
  LOCATION, PLACEMARK, MAPS, LIST, LOGIN
}
...

  fun navigateTo(view: VIEW, code: Int = 0, key: String = &quot;&quot;, value: Parcelable? = null) {
    var intent = Intent(this, PlacemarkListView::class.java)
    when (view) {
      VIEW.LOCATION -&gt; intent = Intent(this, EditLocationView::class.java)
      VIEW.PLACEMARK -&gt; intent = Intent(this, PlacemarkView::class.java)
      VIEW.MAPS -&gt; intent = Intent(this, PlacemarkMapView::class.java)
      VIEW.LIST -&gt; intent = Intent(this, PlacemarkListView::class.java)
      VIEW.LOGIN -&gt; intent = Intent(this, LoginView::class.java)
    }
    if (key != &quot;&quot;) {
      intent.putExtra(key, value)
    }
    startActivityForResult(intent, code)
  }</code></pre>
<p>We need to be able to handle the new logout menu option. This is an extend version of the menu handler in PlacemarkListView:</p>
<h2>PlacemarkListView</h2>
<pre><code>  override fun onOptionsItemSelected(item: MenuItem?): Boolean {
    when (item?.itemId) {
      R.id.item_add -&gt; presenter.doAddPlacemark()
      R.id.item_map -&gt; presenter.doShowPlacemarksMap()
      R.id.item_logout -&gt;presenter.doLogout()
    }
    return super.onOptionsItemSelected(item)
  }</code></pre>
<p>Finally, this will need a new method in PlacemarkListPresenter:</p>
<h2>PlacemarkListPresenter</h2>
<pre><code>  fun doLogout() {
    view?.navigateTo(VIEW.LOGIN)
  }
}</code></pre>
<p>Notice we are just switching to the login screen when logout is selected.</p>
<p>Try this now, and make sure login and logout work as expected.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="05">
            <h1>Firebase</h1>
<p>Visit Firebase and create / log in to your account:</p>
<ul>
<li><a href="https://firebase.google.com/">https://firebase.google.com/</a></li>
</ul>
<p>Create a new Firebase Project:</p>
<p><img src="img/01.png" alt=""></p>
<p>Give the project a name:</p>
<p><img src="img/02.png" alt=""></p>
<p>Once the app is created - you should see the application console (click on <code>Develop</code> to see drop down menu):</p>
<p><img src="img/03.png" alt=""></p>
<p>Select the <code>Authentication</code> panel - </p>
<p><img src="img/04.png" alt=""></p>
<p>Press <code>Set Sign-in Method</code> and in the next screen and enable <code>Email/Password</code>:</p>
<p><img src="img/05.png" alt=""></p>
<p>Your Authentication methods should look like this:</p>
<p><img src="img/06.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="06">
            <h1>Connect the App</h1>
<p>Back in Android Studio, select <code>Tools-&gt;Firebase</code> - you should see the Firebase Assistant:</p>
<p><img src="img/07.png" alt=""></p>
<p>Select <code>Authentication</code>:</p>
<p><img src="img/08.png" alt=""></p>
<p>... and then select <code>Email and password authentication</code>:</p>
<p><img src="img/09.png" alt=""></p>
<p>Now press <code>Connect to Firebase</code></p>
<p>This may require you to authenticate to firebase with your account. Once connected, you should see your firebase created app:</p>
<p><img src="img/10.png" alt=""></p>
<p>Select the app and press <code>Connect to Firebase</code></p>
<p>This will insert a new file into your project called <code>google-services.json</code>. This file is embedded in the <code>app</code> folder. You will need to switch to the <code>Project</code> perspective in Studio in order to see it.</p>
<p>The assistant will also insert additional entries into both of our gradle files. The top level gradle will have this additional entry:</p>
<h2>build.gradle</h2>
<pre><code>    classpath &#39;com.google.gms:google-services:4.0.1&#39;</code></pre>
<p>The app gradle file will have additional libraries. As we are managing our gradle a little differently - we will take control of this ourselves. </p>
<p>This is a revised version of the base gradle file you should use:</p>
<h2>project gradle</h2>
<pre><code>apply plugin: &#39;com.android.application&#39;

apply plugin: &#39;kotlin-android&#39;

apply plugin: &#39;kotlin-android-extensions&#39;

apply plugin: &quot;kotlin-kapt&quot;

apply plugin: &#39;com.google.gms.google-services&#39;

androidExtensions {
  experimental = true
}

android {
  compileSdkVersion 28
  defaultConfig {
    applicationId &quot;org.wit.placemark&quot;
    minSdkVersion 23
    targetSdkVersion 28
    versionCode 1
    versionName &quot;1.0&quot;
    testInstrumentationRunner &quot;androidx.test.runner.AndroidJUnitRunner&quot;
  }
  buildTypes {
    release {
      minifyEnabled false
      proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39;
    }
  }
}

ext {
  app_compat_version = &#39;1.0.2&#39;
  constraint_layout_version = &#39;2.0.0-alpha2&#39;
  material_version = &#39;1.0.0&#39;
  cardview_version = &#39;1.0.0&#39;
  design_library_version = &#39;26.1.0&#39;
  support_library_version = &#39;26.1.0&#39;

  play_services_maps_version = &#39;16.0.0&#39;
  play_services_location_version = &#39;16.0.0&#39;

  anko_version = &#39;0.10.7&#39;
  anko_commons_version = &#39;0.10.7&#39;
  gson_version = &#39;2.8.5&#39;

  room_version = &quot;2.0.0&quot;
  firebase_version = &#39;16.0.5&#39;
}

dependencies {
  implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])
  implementation &quot;org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version&quot;
  implementation &quot;androidx.appcompat:appcompat:$app_compat_version&quot;
  implementation &quot;androidx.constraintlayout:constraintlayout:$constraint_layout_version&quot;
  implementation &quot;com.google.android.material:material:$material_version&quot;
  implementation &quot;androidx.cardview:cardview:$cardview_version&quot;
  implementation &quot;com.google.android.gms:play-services-maps:$play_services_maps_version&quot;
  implementation &quot;com.google.android.gms:play-services-location:$play_services_location_version&quot;
  implementation &quot;org.jetbrains.anko:anko-commons:$anko_commons_version&quot;
  implementation &quot;org.jetbrains.anko:anko:$anko_version&quot;
  implementation &quot;com.google.code.gson:gson:$gson_version&quot;
  implementation &quot;androidx.room:room-runtime:$room_version&quot;
  kapt &quot;androidx.room:room-compiler:$room_version&quot;

  implementation &quot;com.google.firebase:firebase-auth:$firebase_version&quot;
  implementation &quot;com.google.firebase:firebase-database:$firebase_version&quot;

  testImplementation &#39;junit:junit:4.12&#39;
  androidTestImplementation &#39;androidx.test:runner:1.1.0&#39;
  androidTestImplementation &#39;androidx.test.espresso:espresso-core:3.1.0&#39;

}</code></pre>
<p>These are the new features in the project:</p>
<pre><code>...
apply plugin: &#39;com.google.gms.google-services&#39;
...
  firebase_version = &#39;16.0.5&#39;
  ...
  implementation &quot;com.google.firebase:firebase-auth:$firebase_version&quot;
  implementation &quot;com.google.firebase:firebase-database:$firebase_version&quot;
...</code></pre>
<p>Rebuild the application now to make sure all of these libraries can be incorporated correctly.</p>
<h2>google-service.json</h2>
<p>The Firebase wizard will also have generate a file of various credentials for your app in </p>
<ul>
<li>app/app/google-services.json</li>
</ul>
<p>Have a look at the contents of this file now. It contains multiple keys to facilitate authentication to your firebase app. You will need to exclude this from git, particularly if the repo is public:</p>
<h2>.gitignore</h2>
<pre><code>app/google-services.json</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="07">
            <h2>Progress</h2>
<p>When login in, we should display some indication to the user that we are &#39;working&#39; on the login. This is usually via a <code>Progress</code> widget of some kind. Bring one in now to the login layout:</p>
<p><img src="img/17/png" alt=""></p>
<p>It might be structured like this in the layout:</p>
<h2>activity_login.xml</h2>
<pre><code>...
    &lt;ProgressBar
      android:id=&quot;@+id/progressBar&quot;
      style=&quot;@style/Widget.AppCompat.ProgressBar&quot;
      android:layout_width=&quot;196dp&quot;
      android:layout_height=&quot;96dp&quot;
      android:layout_marginStart=&quot;8dp&quot;
      android:layout_marginTop=&quot;8dp&quot;
      android:layout_marginEnd=&quot;8dp&quot;
      android:layout_marginBottom=&quot;8dp&quot;
      app:layout_constraintBottom_toBottomOf=&quot;parent&quot;
      app:layout_constraintEnd_toEndOf=&quot;parent&quot;
      app:layout_constraintStart_toStartOf=&quot;parent&quot;
      app:layout_constraintTop_toBottomOf=&quot;@+id/signUp&quot; /&gt;
...</code></pre>
<p>In LoginView we can then toggle this widget.</p>
<p>First, in onCreate we can make it invisible (or GONE)</p>
<pre><code>    progressBar.visibility = View.GONE</code></pre>
<p>Then we can override the methods already defined in the BaseView class:</p>
<h2>LoginView</h2>
<pre><code>  override fun showProgress() {
    progressBar.visibility = View.VISIBLE
  }

  override fun hideProgress() {
    progressBar.visibility = View.GONE
  }
}</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="08">
            <h1>Signup/Login Implementation</h1>
<p>Back in the LoginPresenter class - we can implement the Firebase login strategy:</p>
<h2>LoginPresenter</h2>
<pre><code>package org.wit.placemark.views.login

import com.google.firebase.auth.FirebaseAuth
import org.jetbrains.anko.toast
import org.wit.placemark.views.BasePresenter
import org.wit.placemark.views.BaseView
import org.wit.placemark.views.VIEW

class LoginPresenter(view: BaseView) : BasePresenter(view) {

  var auth: FirebaseAuth = FirebaseAuth.getInstance()

  fun doLogin(email: String, password: String) {
    view?.showProgress()
    auth.signInWithEmailAndPassword(email, password).addOnCompleteListener(view!!) { task -&gt;
      if (task.isSuccessful) {
        view?.navigateTo(VIEW.LIST)
      } else {
        view?.toast(&quot;Sign Up Failed: ${task.exception?.message}&quot;)
      }
      view?.hideProgress()
    }
  }

  fun doSignUp(email: String, password: String) {
    view?.showProgress()
    auth.createUserWithEmailAndPassword(email, password).addOnCompleteListener(view!!) { task -&gt;
      if (task.isSuccessful) {
        view?.navigateTo(VIEW.LIST)
      } else {
        view?.toast(&quot;Sign Up Failed: ${task.exception?.message}&quot;)
      }
      view?.hideProgress()
    }
  }
}</code></pre>
<p>This will sign up a new user with the Firebase service. Try it now </p>
<p>Make sure to enter a correctly formed email + a password of at least 8 characters.</p>
<p>The application should take you to the main Placemarks screen.</p>
<p>Back in the Firebase console - check the authentication panel to see if the new user is recorded:</p>
<p><img src="img/12.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="Exercises">
            <h1>Solution</h1>
<p>Placemark application so far:</p>
<ul>
<li><a href="archives/archive.zip">archive.zip</a></li>
</ul>
<h2>Exercise 1</h2>
<p>Implement logout. This is the FirebaseAuth method we need:</p>
<ul>
<li><a href="https://firebase.google.com/docs/reference/android/com/google/firebase/auth/FirebaseAuth.html#signOut()">https://firebase.google.com/docs/reference/android/com/google/firebase/auth/FirebaseAuth.html#signOut()</a></li>
</ul>
<h2>Exercise 2</h2>
<p>Adjust the title of the PlacemarkListActivity - such that it displays the logged in users email:</p>
<p><img src="img/13.png" alt=""></p>
<p>The logged in user details are reasonably easy to locate:</p>
<ul>
<li><a href="https://firebase.google.com/docs/auth/web/manage-users">https://firebase.google.com/docs/auth/web/manage-users</a></li>
</ul>
<p>Here is how we could access this in kotlin:</p>
<pre><code>    val user = FirebaseAuth.getInstance().currentUser</code></pre>

          </div>
        
      </div>
    </div>
  </div>


  <br>
  <script>
    $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

    $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

  </script>



  <div class="ui bottom fixed borderless right menu">
    <div class="ui right small menu">
      <div class="ui tiny basic message segment">
         Powered by <a href="https://github.com/edeleastar/tutors-ts">tutors-ts.</a> Unless otherwise stated, this work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      </div>
    </div>
  </div>

  </body>

</html>